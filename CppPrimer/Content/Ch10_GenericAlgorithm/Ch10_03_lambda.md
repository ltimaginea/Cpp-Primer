# ***lambda 表达式***

## 谓词

谓词（``predicate``）是一个可调用的表达式，其返回结果是一个能用作条件的值。标准库算法所使用的谓词分为两类：一元谓词（``unary predicate``，意味着它们只接受单一参数）和二元谓词（``binary predicate``，意味着它们有两个参数）。接受谓词参数的算法对输入序列中的元素调用谓词。因此，元素类型必须能转换为谓词的参数类型。

## 介绍 lambda

一个lambda表达式表示一个可调用的代码单元。我们可以将其理解为一个未命名的内联函数（**匿名函数**）。与任何函数类似，一个lambda具有一个返回类型、一个参数列表和一个函数体。但与函数不同，lambda可能定义在函数内部。一个lambda表达式具有如下形式：

```c++
[capture list] (parameter list) -> return type { function body }
```

其中，capture list（捕获列表）是一个lambda所在函数中定义的局部变量的列表；return type、parameter list和function body与任何普通函数一样，分别表示返回类型、参数列表和函数体。但是，与普通函数不同，lambda必须使用尾置返回来指定返回类型。 

我们可以忽略参数列表和返回类型，但必须永远包含捕获列表和函数体。在lambda中忽略括号和参数列表等价于指定一个空参数列表。

如果忽略返回类型，lambda根据函数体中的代码推断出返回类型。如果函数体只是一个return语句，则返回类型从返回的表达式的类型推断而来。否则，返回类型为void，即如果函数体包含单一return语句之外的任何语句，则编译器推断此lambda返回void。这时就需要显式地指定返回类型。返回类型可以使用跟在参数列表后面的箭头`->`进行设置。如果lambda函数没有任何参数，还需要包含(空)的参数列表，这样做是为了能显式地对返回类型进行指定。

lambda是函数对象。当我们编写了一个lambda后，编译器将该表达式翻译成一个未命名类的未命名对象（**匿名函数对象**）。在lambda表达式产生的类中含有一个重载的函数调用运算符。当使用`auto`定义一个用lambda初始化的变量时，即定义了一个从lambda生成的类型的对象。

自C++ 14起，lambda可以拥有默认参数。

## 捕获列表

**虽然一个lambda可以出现在一个函数中，使用其局部变量，但它只能使用那些明确指明的变量**。一个lambda通过将局部变量包含在其捕获列表中来指出将会使用这些变量。捕获列表指引lambda在其内部包含访问局部变量所需的信息。

捕获列表只用于局部非static变量，lambda可以直接使用局部static变量和在它所在函数之外声明的名字。

类成员变量不能直接捕获，如果想通过lambda方式访问类中的成员，可以通过在捕获列表中显式添加`this`指针或通过隐式捕获。

当出现任一默认捕获符(`&`或`=`)时，也都能隐式捕获当前对象(`*this`)。当它被隐式捕获时，始终被以引用捕获，即使默认捕获符是 `=` 也是如此。当默认捕获符为 `=` 时，`*this` 的隐式捕获被弃用(C++20 起)。([参考 cppreference/lambda](https://en.cppreference.com/w/cpp/language/lambda))

### 值捕获

类似参数传递，变量的捕获方式也可以是值或引用。与传值参数类似，采用值捕获的前提是变量可以拷贝。与参数不同，**被捕获的变量的值是在lambda创建时拷贝，而不是调用时拷贝**。

### 引用捕获

我们定义lambda时也可以采用引用方式捕获变量。

我们也可以从一个函数返回lambda。函数可以直接返回一个可调用对象，或者返回一个类对象，该类含有可调用对象的数据成员。如果函数返回一个lambda，则与函数不能返回一个局部变量的引用类似，此lambda也不能包含引用捕获。

当以引用方式捕获一个变量时，必须保证在lambda执行时变量是存在的。

### 隐式捕获

除了显式列出我们希望使用的来自所在函数的变量之外，还可以让编译器根据lambda体中的代码来推断我们要使用哪些变量。为了指示编译器推断捕获列表，应在捕获列表中写一个`&`或`=`。`&`告诉编译器采用引用捕获方式，`=`则表示采用值捕获方式。

如果我们希望对一部分变量采用值捕获，对其他变量采用引用捕获，则可以混合使用隐式捕获和显式捕获。

当我们混合使用隐式捕获和显式捕获时，捕获列表中的第一个元素必须是一个`&`或`=`。此符号指定了默认捕获方式为引用或值。

当混合使用隐式捕获和显式捕获时，显式捕获的变量必须使用与隐式捕获不同的方式。

![](https://github.com/ltimaginea/Cpp-Primer/blob/main/CppPrimer/Images/Chapter10/Ch10_01_lambdaCaptureList.jpg)

## 可变lambda

默认情况下，对于一个值被拷贝的变量，lambda不会改变其值。如果我们希望能改变一个被捕获的变量的值，就必须在参数列表尾加上关键字`mutable`。因此，可变lambda能省略参数列表。

一个引用捕获的变量是否可以修改依赖于此引用指向的是一个const类型还是一个非const类型。

## ***Tips***

- 对于那种只在一两个地方使用的简单操作，lambda表达式是最有用的。如果我们需要在很多地方使用相同的操作，通常应该定义一个函数，而不是多次编写相同的lambda表达式。类似的，如果一个操作需要很多语句才能完成，通常使用函数更好。
- 显式捕获lambda表达式所依赖的局部变量或形参是更好的软件工程实践。